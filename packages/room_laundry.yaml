################################################################
## Packages / Laundry Room
################################################################
homeassistant:
  customize:
###### Washing Machine ENERGY READINGS
    sensor.washing_machine_amps:
      friendly_name: Amps
      icon: mdi:power-plug
    sensor.washing_machine_watts:
      friendly_name: Watts
      icon: mdi:power-plug
    sensor.washing_machine_kw:
      friendly_name: KW
      icon: mdi:power-plug
    sensor.washing_machine_volts:
      friendly_name: Volttage
      icon: mdi:power-plug
    sensor.washing_machine_status:
      friendly_name: Wash Status
      icon: mdi:clipboard-outline
    switch.washing_machine:
      friendly_name: Washing Machine
      icon: mdi:washing-machine
######DRYER
    sensor.dryer_status:
      friendly_name: Dryer Status
      icon: mdi:clipboard-outline
    binary_sensor.laundry_dryer_vibration:
      friendly_name: Dryer Vibration
###### Motion
    binary_sensor.laundry_motion:
      friendly_name: Laundry Room motion

###### STATE CARD
group:
  laundry_room:
    control: hidden
    name: Laundry Room
    entities:
      - binary_sensor.laundry_motion
      - switch.washing_machine
      - sensor.washing_machine_amps
      - sensor.washing_machine_watts
      - sensor.washing_machine_kw
      - sensor.washing_machine_volts
      - sensor.washing_machine_status
      - sensor.dryer_status

switch:
###### TP LINK SWITCH
  - platform: tplink
    host: 192.168.1.211
    name: 'washing_machine'

binary_sensor:
###### TILT SENSOR FOR DRYER
  - platform: mqtt
    name: 'laundry_dryer_vibration'
    state_topic: "/laundry_room/vibration/Switch"
    qos: 0
    payload_on: "0"
    payload_off: "1"
    device_class: vibration
###### motion SENSOR
  - platform: mqtt
    name: 'laundry_motion'
    state_topic: "/laundry_room/motion/Switch"
    qos: 0
    payload_on: "1"
    payload_off: "0"
    device_class: motion

###### WASHING MACHINE ENERGY SENSORS
sensor:
  - platform: template
    sensors:
      washing_machine_amps:
        value_template: '{{ states.switch.washing_machine.attributes["Current"] | replace(" A", "") | float }}'
        unit_of_measurement: 'A'
      washing_machine_watts:
        value_template: '{{ states.switch.washing_machine.attributes["Current consumption"] | replace(" W", "") | float }}'
        unit_of_measurement: 'W'
      washing_machine_kw:
        value_template: '{{ states.switch.washing_machine.attributes["Total consumption"] | replace(" kW", "") | float }}'
        unit_of_measurement: 'kW'
      washing_machine_volts:
        value_template: '{{ states.switch.washing_machine.attributes["Voltage"] | replace(" V", "") | float }}'
        unit_of_measurement: 'V'
###### STATUS SENSORS
      washing_machine_status:
        value_template: >-
          {%- if states.sensor.washing_machine_watts.state|int <= 4.3 -%}
            Off
          {% else %}
            Running
          {% endif %}
      dryer_status:
        value_template:  >-
          {%- if states.input_boolean.dryer_status.state == 'off' -%}
            Off
          {% else %}
            Running
          {% endif %}

automation:
#Turn on washing_machine_switch if motion is detected.
  # - alias: 'laundry_switch_with_motion'
  #   initial_state: 'on'
  #   trigger:
  #     - platform: state
  #       entity_id: binary_sensor.laundry_motion
  #       to: 'on'
  #       for:
  #         seconds: 20
  #   action:
  #     - service: switch.turn_on
  #       entity_id: switch.washing_machine

###### NOTIFY IF WASH IS DONE ( AND TURN OFF SWITCH )
  - alias: 'notify if washing machine is done'
    initial_state: 'on'
    trigger:
      - platform: state
        entity_id: sensor.washing_machine_status
        from: 'Running'
        to: 'Off'
        for:
          minutes: 4
    action:
      - service: script.laundry_tts
      - service: notify.justin
        data:
          message: 'The Wash has completed.'
      - service: notify.nicole
        data:
          message: 'The Wash has completed.'
      - service: switch.turn_off
        entity_id: switch.washing_machine

###### DRYER AUTOMATIONS
  - alias: 'Dryer Start'
    initial_state: 'on'
    trigger:
      platform: state
      entity_id: input_boolean.dryer_switch
      from: 'off'
      to: 'on'
      for:
        minutes: 4
    action:
      service: input_boolean.turn_on
      entity_id: input_boolean.dryer_status

  - alias: 'Dryer Done'
    initial_state: 'on'
    trigger:
      platform: state
      entity_id: input_boolean.dryer_switch
      from: 'on'
      to: 'off'
      for:
        minutes: 2
    condition:
      condition: state
      entity_id: input_boolean.dryer_status
      state: 'on'
    action:
      - service: notify.justin
        data:
          message: 'The Dryer has completed.'
      - service: notify.nicole
        data:
          message: 'The Dryer has completed.'
      - service: input_boolean.turn_off
        entity_id: input_boolean.dryer_status
      - service: script.dryer_tts

  - alias: 'dryer_status'
    initial_state: 'on'
    trigger:
      - platform: state
        entity_id: binary_sensor.laundry_dryer_vibration
        to: 'on'
      - platform: state
        entity_id: binary_sensor.laundry_dryer_vibration
        to: 'off'
    action:
      - service: script.turn_off
        data:
          entity_id: script.dryer_status
      - service: script.turn_on
        data:
          entity_id: script.dryer_status

script:
  laundry_tts:
    sequence:
    - condition: and
      conditions:
        - condition: template
          value_template: >
            {% if is_state('media_player.kitchen', 'playing') %}
            false
            {% else %}
            true
            {% endif %}
    - service: media_player.volume_set
      data:
        entity_id: media_player.kitchen
        volume_level: '0.50'
    - service: tts.google_say
      data_template:
        entity_id: media_player.kitchen
        message: "The Washing machine has completed it's cycle."

  dryer_tts:
    sequence:
    - condition: and
      conditions:
        - condition: template
          value_template: >
            {% if is_state('media_player.kodi_bedroom_pi', 'playing') %}
            false
            {% else %}
            true
            {% endif %}
    - service: tts.google_say
      data_template:
        entity_id: media_player.kitchen
        message: "The Dryer has completed it's cycle."

  dryer_status:
    sequence:
      - service: homeassistant.turn_on
        entity_id: input_boolean.dryer_switch
      - delay: '00:00:15'
      - service: homeassistant.turn_off
        entity_id: input_boolean.dryer_switch

input_boolean:
  dryer_switch:
    name: dryer_switch
    icon: mdi:sync
    initial: off
  dryer_status:
    name: dryer_status
    icon: mdi:sync
    initial: off
